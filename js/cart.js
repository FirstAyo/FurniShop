document.addEventListener("DOMContentLoaded", async () => { const tbody = document.querySelector("#cart-table tbody"); const totalEl = document.getElementById("cart-total"); const empty = document.getElementById("empty"); const actions = document.getElementById("cart-actions"); function renderRow(p, meta) { const tr = document.createElement("tr"); tr.innerHTML = ` <td>${meta.name || ("Item " + p.id)}</td> <td><input type="number" min="1" value="${p.qty}" data-id="${p.id}" style="width:64px"></td> <td>${Shop.money(p.price)}</td> <td>${Shop.money(p.price * p.qty)}</td> <td><button class="icon-btn rm" data-id="${p.id}">âœ•</button></td>`; tbody.appendChild(tr); } const cart = JSON.parse(localStorage.getItem("cart") || "[]"); if (!cart.length) { empty.style.display = "block"; actions.style.display = "none"; return; } const products = await getProducts(); cart.forEach(item => renderRow(item, products.find(p=>p.id===item.id) || {})); function updateTotals() { const items = Array.from(tbody.querySelectorAll("input[data-id]")).map(inp => ({ id: Number(inp.dataset.id), qty: Number(inp.value), price: (cart.find(c=>c.id===Number(inp.dataset.id))||{}).price })); const sum = items.reduce((a,i)=>a + i.qty*i.price, 0); totalEl.textContent = Shop.money(sum); } updateTotals(); tbody.addEventListener("input", (e) => { if (e.target.matches("input[data-id]")) { const id = Number(e.target.dataset.id); const cartItems = JSON.parse(localStorage.getItem("cart") || "[]"); const found = cartItems.find(c => c.id===id); if (found) { found.qty = Number(e.target.value) || 1; localStorage.setItem("cart", JSON.stringify(cartItems)); } updateTotals(); } }); tbody.addEventListener("click", (e) => { if (e.target.closest(".rm")) { const id = Number(e.target.closest(".rm").dataset.id); let cartItems = JSON.parse(localStorage.getItem("cart") || "[]"); cartItems = cartItems.filter(c=>c.id!==id); localStorage.setItem("cart", JSON.stringify(cartItems)); e.target.closest("tr").remove(); if (!cartItems.length) location.reload(); else updateTotals(); } }); });